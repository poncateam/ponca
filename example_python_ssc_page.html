<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ponca: Screen Space Curvature using Cuda and Python</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSsymbols.js", "TeX/AMSmath.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="ponca.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Ponca
   &#160;<span id="projectnumber">dddac26ed5e9b2f7c97e6668536726d213c39450</span>
   </div>
   <div id="projectbrief">Point Cloud Analysis library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="example_page.html">Examples</a></li>  </ul>
</div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Screen Space Curvature using Cuda and Python </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="pyssgl_intro_sec"></a>
Introduction</h1>
<p>This is an example that use <a class="el" href="namespace_ponca.html" title="This module provides efficient methods for the fitting and analysis of point-clouds in arbitrary dime...">Ponca</a> to compute Screen Space Curvature in python using Cuda.</p>
<h2><a class="anchor" id="pyssgl_intro_sec_dep_subsec"></a>
Installation and usage</h2>
<p>This example requires the following python packages:</p><ul>
<li>pycuda</li>
<li>matplotlib</li>
</ul>
<p>as well as a working cuda setup (tested with 5.0 and 7.0), and the lastest version of <b>eigen dev branch</b> which manage nvcc compiler.</p>
<p>To compile and run the example, call </p><div class="fragment"><div class="line">cd build &amp;&amp; make ssgls_py</div>
<div class="line">cd examples/python &amp;&amp; python ssgls.py -s 10 -p ./data/ssgls_sample_wc.png -n ./data/ssgls_sample_normal.png</div>
</div><!-- fragment --><p>The script will load the input pictures and compute the curvature for a screenspace neighborhood 10x10 pixels. </p><div class="image">
<img src="ssgls_input.png" alt=""/>
<div class="caption">
Screen-Space Curvature typical input. Left: world coordinates. Right: remapped normal vectors</div></div>
<p>It will generate this picture </p><div class="image">
<img src="ssgls_result1.png" alt=""/>
<div class="caption">
Screen-Space Curvature estimation</div></div>
<p>as well as the following trace on the standard output </p><div class="fragment"><div class="line">Load CUDA kernel ........... DONE in 0.024 seconds.</div>
<div class="line">Init Input data ............ DONE in 13.390 seconds.</div>
<div class="line">Init queries ............... DONE in 0.720 seconds.</div>
<div class="line">Set memory configuration ... DONE in 0.004 seconds.</div>
<div class="line">Launch kernel .............. DONE in 1.505 seconds.</div>
<div class="line"> </div>
<div class="line">###########Configuration#############</div>
<div class="line">Image size: 1902 x 911</div>
<div class="line">NbQueries:  1732722</div>
<div class="line">Scale:      10</div>
<div class="line"><span class="preprocessor">################Results################</span></div>
<div class="line">Max value:  25.3449363708</div>
<div class="line">Min value:  -31.8370857239</div>
<div class="line">#######################################</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Don't worry about the important execution time, this example uses a naive and inefficient approach to represent queries with numpy, making the total process really slow. However, the real computation time in cuda is indicated by the last line of the timing trace. Note that we do not use any re-sampling technique, that is why this step is directly related to the scale parameter.</dd></dl>
<h1><a class="anchor" id="pyssgl_cuda_sec"></a>
Cuda programming</h1>
<p>Here are the technical details related to the cuda and python biding for screen-space curvature estimation.</p>
<h2><a class="anchor" id="pyssgl_cuda_mypoint_sec"></a>
Define fitting data structure</h2>
<div class="fragment"><div class="line">class MyPoint</div>
<div class="line">{</div>
<div class="line">public:</div>
<div class="line">    enum {Dim = 3};</div>
<div class="line">    typedef float Scalar;</div>
<div class="line">    typedef Eigen::Matrix&lt;Scalar, Dim, 1&gt; VectorType;</div>
<div class="line">    typedef Eigen::Matrix&lt;Scalar, Dim, Dim&gt; MatrixType;</div>
<div class="line">    typedef Eigen::Matrix&lt;Scalar, 2, 1&gt;   ScreenVectorType;</div>
<div class="line"> </div>
<div class="line">    MULTIARCH inline MyPoint(   const VectorType&amp; _pos        = VectorType::Zero(),</div>
<div class="line">                                const VectorType&amp; _normal     = VectorType::Zero(),</div>
<div class="line">                                const ScreenVectorType&amp; _spos = ScreenVectorType::Zero(),</div>
<div class="line">                                const Scalar _dz = 0.f)</div>
<div class="line">        : m_pos(_pos), m_normal(_normal), m_spos(_spos), m_dz(_dz){}</div>
<div class="line"> </div>
<div class="line">    MULTIARCH inline const VectorType&amp; pos()    const { return m_pos; }</div>
<div class="line">    MULTIARCH inline const VectorType&amp; normal() const { return m_normal; }</div>
<div class="line">    MULTIARCH inline const ScreenVectorType&amp; spos() const { return m_spos; }</div>
<div class="line">    MULTIARCH inline const float &amp; dz() const { return m_dz; }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    MULTIARCH inline VectorType&amp; pos()   { return m_pos; }</div>
<div class="line">    MULTIARCH inline VectorType&amp; normal()    { return m_normal; }</div>
<div class="line">    MULTIARCH inline ScreenVectorType&amp; spos() { return m_spos; }</div>
<div class="line">    MULTIARCH inline float&amp; dz()     { return m_dz; }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">private:</div>
<div class="line">    ScreenVectorType m_spos;</div>
<div class="line">    VectorType  m_pos, m_normal;</div>
<div class="line">    float m_dz; // depth threshold</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="pyssgl_cuda_weight_sec"></a>
Define weighting functions</h2>
<div class="fragment"><div class="line">class ProjectWeightFunc: public Grenaille::DistWeightFunc&lt;MyPoint, Grenaille::SmoothWeightKernel&lt;Scalar&gt; &gt;</div>
<div class="line">{</div>
<div class="line">public:</div>
<div class="line">    typedef MyPoint::Scalar Scalar;</div>
<div class="line">    typedef MyPoint::VectorType VectorType;</div>
<div class="line"> </div>
<div class="line">    /*</div>
<div class="line">    Default constructor (needed by Grenaille). Note that the screenspace</div>
<div class="line">    evaluation position is specified as parameter</div>
<div class="line">    */</div>
<div class="line">    MULTIARCH inline ProjectWeightFunc( const Scalar&amp; _t                = 1.f,</div>
<div class="line">                                        const ScreenVectorType&amp; _refPos = ScreenVectorType::Zero(),</div>
<div class="line">                                        const Scalar&amp; _dz               = 0.f)</div>
<div class="line">        : Grenaille::DistWeightFunc&lt;MyPoint, Grenaille::SmoothWeightKernel&lt;Scalar&gt; &gt;(_t), m_refPos(_refPos), m_dz(_dz) {}</div>
<div class="line"> </div>
<div class="line">    MULTIARCH inline Scalar w(const VectorType&amp; _q, const MyPoint&amp;  _attributes) const</div>
<div class="line">    {</div>
<div class="line">        Scalar d  = (_attributes.spos()-m_refPos).norm();</div>
<div class="line">        const Scalar dz = _attributes.dz();</div>
<div class="line"> </div>
<div class="line">        if (d &gt; m_t || dz &gt; m_dz)</div>
<div class="line">            return Scalar(0.);</div>
<div class="line"> </div>
<div class="line">        return m_wk.f(d/m_t);</div>
<div class="line">    }</div>
<div class="line">private:</div>
<div class="line">    ScreenVectorType m_refPos;</div>
<div class="line">    float m_dz;</div>
<div class="line">};</div>
</div><!-- fragment --> <h2><a class="anchor" id="pyssgl_cuda_fit_sec"></a>
Define fitting primitive</h2>
<div class="fragment"><div class="line">typedef Grenaille::Basket&lt;MyPoint,ProjectWeightFunc,Grenaille::OrientedSphereFit, Grenaille::GLSParam&gt; Gls;</div>
</div><!-- fragment --><h2><a class="anchor" id="pyssgl_cuda_kernel_sec"></a>
Kernel</h2>
<div class="fragment"><div class="line">extern &quot;C&quot; { </div>
<div class="line">__global__ void doGLS_kernel(int* _params, //[w, h, scale]</div>
<div class="line">                             float* _positions,</div>
<div class="line">                             float* _normals,</div>
<div class="line">                             float* _result)</div>
<div class="line">{</div>
<div class="line">    </div>
<div class="line">    uint x = (blockIdx.x * blockDim.x) + threadIdx.x;</div>
<div class="line">    uint y = (blockIdx.y * blockDim.y) + threadIdx.y;</div>
<div class="line">    </div>
<div class="line">    const int &amp;width     = _params[0];</div>
<div class="line">    const int &amp;height    = _params[1];</div>
<div class="line"> </div>
<div class="line">    if (x &lt; width &amp;&amp; y &lt; height)</div>
<div class="line">    {</div>
<div class="line">        const int &amp;scale = _params[2];</div>
<div class="line"> </div>
<div class="line">        ScreenVectorType refPos;</div>
<div class="line">        refPos &lt;&lt; x, y;</div>
<div class="line"> </div>
<div class="line">        int dx, dy; // neighbor offset ids</div>
<div class="line">        int nx, ny; // neighbor ids</div>
<div class="line"> </div>
<div class="line">        Gls gls;</div>
<div class="line">        gls.setWeightFunc(ProjectWeightFunc(scale, refPos));</div>
<div class="line">        gls.init( getVector(x,y,width,height,_positions) );</div>
<div class="line"> </div>
<div class="line">        if (getVector(x,y,width,height,_normals).squaredNorm() == 0.f )</div>
<div class="line">        {</div>
<div class="line">            _result[getId(x,y,width,height,0,1)] = -1.0;</div>
<div class="line">        }</div>
<div class="line">        else</div>
<div class="line">        {</div>
<div class="line">            //_result[getId(x,y,width,height,0,1)] = getVector(x,y,width,height,_normals)(0);</div>
<div class="line">            VectorType p, n;</div>
<div class="line"> </div>
<div class="line">            // collect neighborhood</div>
<div class="line">            VectorType one = VectorType::Zero();</div>
<div class="line"> </div>
<div class="line">            for(dy = -scale; dy != scale; dy++)</div>
<div class="line">            {</div>
<div class="line">                for(dx = -scale; dx != scale; dx++)</div>
<div class="line">                {</div>
<div class="line">                    nx = x+dx;</div>
<div class="line">                    ny = y+dy;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">                    // Check image boundaries</div>
<div class="line">                    if (nx &gt;= 0 &amp;&amp; ny &gt;= 0 &amp;&amp; nx &lt; width &amp;&amp; ny &lt; height)</div>
<div class="line">                    {</div>
<div class="line">                        n = getVector(nx,ny,width,height,_normals);</div>
<div class="line"> </div>
<div class="line">                        // add nei only when the _normal is properly defined</div>
<div class="line">                        // need to use an explicit floating point comparison with pycuda</div>
<div class="line">                        if (n.squaredNorm() != 0.f )</div>
<div class="line">                        {</div>
<div class="line"> </div>
<div class="line">                            // RGB to XYZ remapping</div>
<div class="line">                            n =  2.f * n - one;</div>
<div class="line">                            n.normalize();</div>
<div class="line"> </div>
<div class="line">                            // GLS computation</div>
<div class="line">                            gls.addNeighbor(MyPoint(getVector(nx,ny,width,height,_positions),</div>
<div class="line">                                n,</div>
<div class="line">                                ScreenVectorType(nx,ny)));</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            // closed form minimization</div>
<div class="line">            gls.finalize();</div>
<div class="line">            _result[getId(x,y,width,height,0,1)] = gls.kappa();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">}</div>
</div><!-- fragment --> <h2><a class="anchor" id="pyssgl_cuda_access_sec"></a>
Memory access</h2>
<p>We use numpy to format the input data, filled by dimension (in object space) and then by the screen-space coordinates: </p><div class="fragment"><div class="line">__device__ int getId(const int _x,</div>
<div class="line">                     const int _y,</div>
<div class="line">                     const int _width,</div>
<div class="line">                     const int _height,</div>
<div class="line">                     const int _component,</div>
<div class="line">                     const int _nbComponent)</div>
<div class="line">{</div>
<div class="line">    return (_component) + _nbComponent*(_x + _y * _width);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">__device__ VectorType getVector(const int _x,</div>
<div class="line">                                const int _y,</div>
<div class="line">                                const int _width,</div>
<div class="line">                                const int _height,</div>
<div class="line">                                const float* _buffer)</div>
<div class="line">{</div>
<div class="line">    VectorType r;</div>
<div class="line">    r &lt;&lt; Scalar(_buffer[getId(_x,_y,_width,_height,0,3)]),</div>
<div class="line">        Scalar(_buffer[getId(_x,_y,_width,_height,1,3)]),</div>
<div class="line">        Scalar(_buffer[getId(_x,_y,_width,_height,2,3)]);</div>
<div class="line">    return r;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
</div><!-- fragment --><h1><a class="anchor" id="pyssgl_python_sec"></a>
Python script</h1>
<p>We use numpy to format input data.</p>
<div class="fragment"><div class="line"><span class="comment"># This Source Code Form is subject to the terms of the Mozilla Public</span></div>
<div class="line"><span class="comment"># License, v. 2.0. If a copy of the MPL was not distributed with this</span></div>
<div class="line"><span class="comment"># file, You can obtain one at http://mozilla.org/MPL/2.0/.</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">import</span> pycuda.autoinit</div>
<div class="line"><span class="keyword">import</span> pycuda.driver <span class="keyword">as</span> drv</div>
<div class="line"><span class="keyword">import</span> numpy</div>
<div class="line"><span class="keyword">import</span> Image</div>
<div class="line"><span class="keyword">import</span> time</div>
<div class="line"><span class="keyword">import</span> sys, getopt</div>
<div class="line"> </div>
<div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div>
<div class="line"><span class="keyword">import</span> matplotlib.image <span class="keyword">as</span> mpimg</div>
<div class="line"> </div>
<div class="line"><span class="keyword">from</span> pycuda.compiler <span class="keyword">import</span> SourceModule</div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">start_time=0.0</div>
<div class="line">  </div>
<div class="line"><span class="keyword">def </span>startTimer( funcname, quiet ):</div>
<div class="line">  <span class="keyword">global</span> start_time</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">if</span> <span class="keywordflow">not</span> quiet:</div>
<div class="line">    sys.stdout.write(funcname)</div>
<div class="line">    sys.stdout.flush()  </div>
<div class="line">  start_time = time.time()</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>stopTimer(quiet):</div>
<div class="line">  elapsed_time = time.time() - start_time</div>
<div class="line">  <span class="keywordflow">if</span> <span class="keywordflow">not</span> quiet:</div>
<div class="line">    <span class="keywordflow">print</span> <span class="stringliteral">&#39;DONE in {0:.3f} seconds.&#39;</span>.format(elapsed_time)  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>loadKernel():                   </div>
<div class="line">  module = drv.module_from_file(<span class="stringliteral">&quot;ssgls.ptx&quot;</span>)      </div>
<div class="line">  glsKernel    = module.get_function(<span class="stringliteral">&quot;doGLS_kernel&quot;</span>)</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">return</span> module, glsKernel</div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">    </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>initInputData(imgNormPath, imgwcPath): </div>
<div class="line">  i_normals   = Image.open (imgNormPath)</div>
<div class="line">  i_positions = Image.open (imgwcPath)</div>
<div class="line"> </div>
<div class="line">  <span class="comment"># Todo: check dimensions for depth, normals and positions</span></div>
<div class="line">  (w,h)     = i_positions.size     </div>
<div class="line">  length    = w*h;      </div>
<div class="line"> </div>
<div class="line">  normals   = numpy.array(i_normals.getdata()).reshape(3*length,1).astype(numpy.float32) / 255.0;</div>
<div class="line">  positions = numpy.array(i_positions.getdata()).reshape(3*length,1).astype(numpy.float32) / 255.0;</div>
<div class="line">  </div>
<div class="line">  positions = positions * 2.0 - 1.0;</div>
<div class="line">    </div>
<div class="line">  <span class="keywordflow">return</span> w, h, normals, positions</div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">    </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>initQueries(w,h):</div>
<div class="line">  nbQueries = w*h</div>
<div class="line"> </div>
<div class="line">  queries   = numpy.zeros(2*nbQueries).astype(numpy.float32);</div>
<div class="line">  <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range (0,h):</div>
<div class="line">      <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range (0,w):</div>
<div class="line">          queries[2*(i + j*w)] = i</div>
<div class="line">          queries[2*(i + j*w)+1] = j</div>
<div class="line">  <span class="keywordflow">return</span> nbQueries, queries</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>main(argv):    </div>
<div class="line">    </div>
<div class="line"> </div>
<div class="line">  scale       = 10 <span class="comment"># neighborhood size in pixels</span></div>
<div class="line">  imgNormPath = <span class="stringliteral">&#39;&#39;</span></div>
<div class="line">  imgwcPath   = <span class="stringliteral">&#39;&#39;</span></div>
<div class="line">  quiet       = <span class="keyword">False</span></div>
<div class="line">  outputPath  = <span class="stringliteral">&#39;&#39;</span></div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">try</span>:</div>
<div class="line">    opts, args = getopt.getopt(argv,<span class="stringliteral">&quot;s:p:n:o:q&quot;</span>,[<span class="stringliteral">&quot;scale=&quot;</span>,<span class="stringliteral">&quot;positions=&quot;</span>,<span class="stringliteral">&quot;normals=&quot;</span>,<span class="stringliteral">&quot;output=&quot;</span>,<span class="stringliteral">&quot;quiet&quot;</span>])</div>
<div class="line">  <span class="keywordflow">except</span> getopt.GetoptError:</div>
<div class="line">    <span class="keywordflow">print</span> <span class="stringliteral">&#39;ssgl.py -s &lt;scale&gt; -p &lt;positions&gt; -n &lt;normals&gt;&#39;</span></div>
<div class="line">    sys.exit(2)</div>
<div class="line">  <span class="keywordflow">for</span> opt, arg <span class="keywordflow">in</span> opts:</div>
<div class="line">    <span class="keywordflow">if</span> opt == <span class="stringliteral">&#39;-h&#39;</span>:</div>
<div class="line">      <span class="keywordflow">print</span> <span class="stringliteral">&#39;ssgl.py -s &lt;scale&gt; -p &lt;positions&gt; -n &lt;normals&gt;&#39;</span></div>
<div class="line">      sys.exit()</div>
<div class="line">    <span class="keywordflow">elif</span> opt <span class="keywordflow">in</span> (<span class="stringliteral">&quot;-s&quot;</span>, <span class="stringliteral">&quot;--scale&quot;</span>):</div>
<div class="line">      scale = int(arg)</div>
<div class="line">    <span class="keywordflow">elif</span> opt <span class="keywordflow">in</span> (<span class="stringliteral">&quot;-p&quot;</span>, <span class="stringliteral">&quot;--imgpath&quot;</span>):</div>
<div class="line">      imgwcPath = arg</div>
<div class="line">    <span class="keywordflow">elif</span> opt <span class="keywordflow">in</span> (<span class="stringliteral">&quot;-n&quot;</span>, <span class="stringliteral">&quot;--normals&quot;</span>):</div>
<div class="line">      imgNormPath = arg</div>
<div class="line">    <span class="keywordflow">elif</span> opt <span class="keywordflow">in</span> (<span class="stringliteral">&quot;-o&quot;</span>, <span class="stringliteral">&quot;--output&quot;</span>):</div>
<div class="line">      outputPath = arg</div>
<div class="line">    <span class="keywordflow">elif</span> opt <span class="keywordflow">in</span> (<span class="stringliteral">&quot;-q&quot;</span>, <span class="stringliteral">&quot;--quiet&quot;</span>):</div>
<div class="line">      quiet = <span class="keyword">True</span></div>
<div class="line">      </div>
<div class="line">  </div>
<div class="line">   </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">  startTimer(<span class="stringliteral">&quot;Load CUDA kernel ........... &quot;</span>, quiet)</div>
<div class="line">  module, glsKernel = loadKernel()</div>
<div class="line">  stopTimer(quiet)  </div>
<div class="line">  </div>
<div class="line">  startTimer(<span class="stringliteral">&quot;Init Input data ............ &quot;</span>, quiet)</div>
<div class="line">  w, h, normals, positions = initInputData (imgNormPath, imgwcPath)</div>
<div class="line">  stopTimer(quiet)    </div>
<div class="line">  </div>
<div class="line">  nbQueries  = w*h</div>
<div class="line">    </div>
<div class="line">  startTimer(<span class="stringliteral">&quot;Init result array memory ... &quot;</span>, quiet)</div>
<div class="line">  result = numpy.zeros(nbQueries).astype(numpy.float32)</div>
<div class="line">  stopTimer(quiet)</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  blockSize  = 32</div>
<div class="line">  gridWidth  = w/blockSize</div>
<div class="line">  gridHeight = h/blockSize</div>
<div class="line">  </div>
<div class="line">  w          = numpy.int32(w)</div>
<div class="line">  h          = numpy.int32(h)</div>
<div class="line">  scale      = numpy.int32(scale)</div>
<div class="line"> </div>
<div class="line">  startTimer(<span class="stringliteral">&quot;Launch kernel .............. &quot;</span>, quiet)</div>
<div class="line">  glsKernel(</div>
<div class="line">          drv.In(numpy.array([w, h, scale])),</div>
<div class="line">          drv.In(positions),</div>
<div class="line">          drv.In(normals),</div>
<div class="line">          drv.Out(result),</div>
<div class="line">          block = (blockSize,  blockSize,  1), </div>
<div class="line">          grid  = (gridWidth,gridHeight))</div>
<div class="line">          </div>
<div class="line">  stopTimer(quiet)  </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">  whereAreNaNs = numpy.isnan(result);</div>
<div class="line">  result[whereAreNaNs] = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> <span class="keywordflow">not</span> quiet:</div>
<div class="line">    <span class="keywordflow">print</span> <span class="stringliteral">&#39;\n###########Configuration#############&#39;</span></div>
<div class="line">    <span class="keywordflow">print</span> <span class="stringliteral">&#39;Image size: {} x {}&#39;</span>.format(w,h)</div>
<div class="line">    <span class="keywordflow">print</span> <span class="stringliteral">&#39;NbQueries:  {}&#39;</span>.format(nbQueries)</div>
<div class="line">    <span class="keywordflow">print</span> <span class="stringliteral">&#39;Scale:      {}&#39;</span>.format(scale)</div>
<div class="line">    <span class="keywordflow">print</span> <span class="stringliteral">&#39;################Results################&#39;</span></div>
<div class="line">    <span class="keywordflow">print</span> <span class="stringliteral">&#39;Max value:  {}&#39;</span>.format(result.max())</div>
<div class="line">    <span class="keywordflow">print</span> <span class="stringliteral">&#39;Min value:  {}&#39;</span>.format(result.min())</div>
<div class="line">    <span class="keywordflow">print</span> <span class="stringliteral">&#39;#######################################&#39;</span></div>
<div class="line"> </div>
<div class="line">  scaleFactor = max(abs(result.max()), abs(result.min())); <span class="comment">#/ (2.0*scaleFactor) + 0.5) </span></div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">if</span> outputPath == <span class="stringliteral">&#39;&#39;</span>:</div>
<div class="line">    plt.imshow(result.reshape(h,w), vmin=-scaleFactor, vmax=scaleFactor, cmap=<span class="stringliteral">&#39;seismic&#39;</span>)</div>
<div class="line">    plt.show()</div>
<div class="line">  <span class="keywordflow">else</span>:</div>
<div class="line">    plt.imsave(fname=outputPath, arr=result.reshape(h,w), vmin=-1.0, vmax=1.0, cmap=<span class="stringliteral">&#39;seismic&#39;</span>)  </div>
<div class="line">  </div>
<div class="line"><span class="keywordflow">if</span> __name__ == <span class="stringliteral">&quot;__main__&quot;</span>:</div>
<div class="line">  main(sys.argv[1:])</div>
<div class="line"> </div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue May 4 2021 12:48:14 for Ponca by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
